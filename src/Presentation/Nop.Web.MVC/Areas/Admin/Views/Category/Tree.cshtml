@model IList<Nop.Core.Domain.Catalog.Category>
@using Telerik.Web.Mvc.UI;
@{
    var categoryService = EngineContext.Current.Resolve<Nop.Services.Catalog.ICategoryService>();
}
<div class="section-header">
    <div class="title">
        <img src="@Url.Content("~/Areas/Admin/Content/images/ico-catalog.png")" />
        @T("Manage categories") @Html.ActionLink("(switch to list view)", "List")
    </div>
    <div class="options">
        <input type="button" onclick="location.href='@Url.Action("Create")'" value="Add new" class="adminButtonBlue" />
    </div>
</div>
<table class="adminContent">
    <tr>
        <td>
            @(Html.Telerik().TreeView()
        .Name("AjaxTreeView")
        .BindTo(Model, (item, category) =>
        {
            item.Text = category.Name;
            item.Value = category.Id.ToString();
            item.LoadOnDemand = categoryService.GetAllCategoriesByParentCategoryId(category.Id).Count > 0;
            item.Enabled = true;
            item.ImageUrl = Url.Content("~/Areas/Admin/Content/images/ico-content.png");
        })
        .ClientEvents(events => events
                        .OnSelect("onSelect")
                        .OnNodeDropped("onNodeDropped")
                )
        .DataBinding(dataBinding => dataBinding
                            .Ajax().Select("TreeLoadChildren", "Category")
        )
        .ShowLines(true)
                .DragAndDrop(true))
            <script type="text/javascript">
            function onNodeDropped(e) {
                var treeview = $('#AjaxTreeView').data("tTreeView");
                
                var item = treeview.getItemValue(e.item);
                var destination = treeview.getItemValue(e.destinationItem);
                
                var data = {};
                data.item = item;
                data.destinationitem = destination;
                data.position = e.dropPosition;

                $.ajax({
                    url: "@Url.Action("TreeDrop")",
                    data: data,
                    type: "POST",
                    success: function () {
                        $(this).addClass("done");
                    }
                });
            }

            function onSelect(e) {
                var itemId = $('#AjaxTreeView').data('tTreeView').getItemValue(e.item);
                var url = "@(Url.Action("Edit"))" + "/" + itemId;
                window.location = url;
            }
            </script>
        </td>
    </tr>
</table>
